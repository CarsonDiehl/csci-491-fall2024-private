<form action="/todos" method="post" id="todo-form">
    <label>
        New Todo
        <input
                {{ 'autofocus' if editing is undefined }}
        required
        type="text"
        name="todo"
        placeholder="Enter New Todo"
        id="todo-input">
    </label>
    <button type="button" id="voice-button">
        <img src="/img/microphone-icon.svg" alt="Voice Input" width="20">
    </button>
    <input type="hidden" name="view" value="{{ view }}">
    <div class="tag-container">
        {% for tag in tags %}
        <label class="tag-label" style="--tag-color: {{ tag.color }}">
            <input type="checkbox"
                   name="tags"
                   value="{{ tag.id }}"
                   class="tag-checkbox">
            <span class="tag-button">
            {{ tag.name }}
        </span>
        </label>
        {% endfor %}
    </div>
</form>

<div>
    <button type="button"
            class="tag-button"
            hx-get="/new_tag"
            hx-swap="outerHTML">
        + Add Tag
    </button>
    <br>
</div>


<!-- Sorting dropdown -->
<form method="get" action="/todos" id="sort-form">
    <label for="sort-order">Sort by:</label>
    <select name="sort" id="sort-order" onchange="this.form.submit()">
        <option value="priority_desc" {% if request.args.get('sort') == 'priority_desc' %}selected{% endif %}>
            Priority (Low to High)
        </option>
        <option value="priority_asc" {% if request.args.get('sort') == 'priority_asc' %}selected{% endif %}>
            Priority (High to Low)
        </option>
        <option value="order" {% if request.args.get('sort') == 'order' %}selected{% endif %}>
            Default Order
        </option>
    </select>
</form>

<a hx-get="/todos/reorder"
   hx-target="#todos-list"
   hx-swap="outerHTML"> Reorder Todos </a>
<ol id="todos-list">
    {% for todo in todos %}
    <li>
        {% if todo.id == editing %}
        <form method="post" action="/todos/{{ todo.id }}">
            <input autofocus required type="text" value="{{ todo.text }}" name="todo">
            <input type="hidden" name="view" value="{{ view }}">
        </form>
        <!-- Priority selection form -->
        <form hx-post="/todos/{{ todo.id }}/update" hx-target="main" method="post">
            <label for="priority-{{ todo.id }}">Priority</label>
            <select name="priority" id="priority-{{ todo.id }}">
                <option value="1" {% if todo.priority== 1 %} selected {% endif %}>High</option>
                <option value="2" {% if todo.priority== 2 %} selected {% endif %}>Medium</option>
                <option value="3" {% if todo.priority== 3 %} selected {% endif %}>Low</option>
            </select>
            <button type="submit">Save</button>
        </form>
        {% else %}
            <form hx-post="/todos/{{ todo.id }}/toggle"
                  hx-target="main"
                  ondblclick="document.getElementById('edit-{{ todo.id }}').submit()">
                <button style="all:unset">
                    {% if todo.complete %}
                        <img src="/img/todo-white.svg" width="20px">
                    {% else %}
                        <img src="/img/unchecked-white.svg" width="20px">
                    {% endif %}
                </button>
                <input type="hidden" name="view" value="{{ view }}">
                {% if todo.complete %}
                    <del>{{ todo.text }}</del>
                {% if todo.priority== 1 %} <em style="color:red">Priority: High</em>{% endif %}
                {% if todo.priority== 2 %} <em style="color:yellow">Priority: Medium</em>{% endif %}
                {% if todo.priority== 3 %} <em style="color:green">Priority: Low</em>{% endif %}
                {% else %}
                    {{ todo.text }}
                {% if todo.priority== 1 %} <em style="color:red">Priority: High</em>{% endif %}
                {% if todo.priority== 2 %} <em style="color:yellow">Priority: Medium</em>{% endif %}
                {% if todo.priority== 3 %} <em style="color:green">Priority: Low</em>{% endif %}
                {% endif %}
            </form>
            <form id="edit-{{ todo.id }}" action="/todos/{{ todo.id }}/edit" method="get">
                <input type="hidden" name="view" value="{{ view }}">
            </form>


        {% endif %}
    </li>
{% endfor %}
</ol>

<nav>
    <ul>
        <li>
            <a class="{{ 'contrast' if view == None }}" href="/todos">All</a>
        </li>
    </ul>
    <ul>
        <li>
            <a class="{{ 'contrast' if view == 'active' }}" href="/todos?view=active">Active</a>
        </li>
    </ul>
    <ul>
        <li>
            <a class="{{ 'contrast' if view == 'complete' }}" href="/todos?view=complete">Complete</a>
        </li>
    </ul>
</nav>

<script>
    document.getElementById("voice-button").addEventListener("click", () => {
        if (!("webkitSpeechRecognition" in window)) {
            alert("Sorry, your browser does not support voice input.");
            return;
        }

        const recognition = new webkitSpeechRecognition();
        recognition.lang = "en-US";
        recognition.interimResults = false;

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            console.log("Voice input:", transcript);

            // Send the transcript to the Flask backend
            fetch('/voice-input', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ todo: transcript }),
            }).then(response => {
                if (response.ok) {
                    location.reload(); // Reload the page to reflect the new todo
                } else {
                    alert('Failed to add todo from voice input.');
                }
            });
        };

        recognition.start();
    });
</script>
